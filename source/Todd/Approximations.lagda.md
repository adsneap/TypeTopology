
```agda
{-# OPTIONS --allow-unsolved-metas --exact-split --auto-inline --experimental-lossy-unification #-}

open import MLTT.Spartan renaming (_+_ to _‚àî_)
open import Notation.CanonicalMap
open import Notation.Order
open import Integers.Integers
open import Integers.Addition renaming (_+_ to _‚Ñ§+_;  _-_ to _‚Ñ§-_)
open import Integers.Multiplication renaming (_*_ to _‚Ñ§*_)
open import Integers.Negation renaming (-_ to ‚Ñ§-_ )
open import Integers.Order
open import UF.Base
open import UF.FunExt
open import UF.PropTrunc
open import UF.Subsingletons
open import UF.Quotient
open import UF.Powerset hiding (ùïã)

module Todd.Approximations
  (pt : propositional-truncations-exist)
  (fe : FunExt)
  (pe : PropExt)
  (sq : set-quotients-exist)
 where

open import Todd.RationalsDyadic fe renaming (1/2‚Ñ§[1/2] to 1/2)
open import Todd.DyadicReals pe pt fe
open import Todd.TBRFunctions pt fe pe sq
open import Todd.TernaryBoehmReals pt fe pe sq hiding (Œπ ; _‚â§_‚â§_)
open import Todd.TBRDyadicReals pt fe pe sq
open PropositionalTruncation pt

open OrderProperties DyOrPr
open DyadicProperties Dp renaming (_‚Ñ§[1/2]+_ to _+_ ; ‚Ñ§[1/2]-_ to -_ ; _‚Ñ§[1/2]-_ to _-_ ; _‚Ñ§[1/2]*_ to _*_)
                                    
open import Naturals.Order renaming (max to ‚Ñïmax) hiding (‚â§-refl ; ‚â§-trans)

ùîª = ‚Ñ§[1/2]

-- SEQUENCES

-- Def 1.5
is-odcs : (‚Ñ§ ‚Üí ‚Ñ§[1/2] √ó ‚Ñ§[1/2]) ‚Üí ùì§‚ÇÄ  Ãá  
is-odcs Œ∂ = ((n : ‚Ñ§) ‚Üí pr‚ÇÅ (Œ∂ n) ‚â§‚Ñ§[1/2] pr‚ÇÇ (Œ∂ n))
          √ó ((œµ : ùîª) ‚Üí Œ£ n Íûâ ‚Ñ§ , ((pr‚ÇÇ (Œ∂ n) - pr‚ÇÅ (Œ∂ n)) ‚â§‚Ñ§[1/2] œµ))
          √ó ((n : ‚Ñ§) ‚Üí (pr‚ÇÅ (Œ∂ n) ‚â§‚Ñ§[1/2] pr‚ÇÅ (Œ∂ (succ‚Ñ§ n)))
                     √ó (pr‚ÇÇ (Œ∂ (succ‚Ñ§ n)) ‚â§‚Ñ§[1/2] pr‚ÇÇ (Œ∂ n)))

is-odcs-c‚ÇÉ-lemma-ns : (Œ∂ : (‚Ñ§ ‚Üí ‚Ñ§[1/2] √ó ‚Ñ§[1/2])) ‚Üí ((c‚ÇÅ , c‚ÇÇ , c‚ÇÉ) : is-odcs Œ∂)
                    ‚Üí (n‚ÇÅ n‚ÇÇ : ‚Ñ§) ‚Üí (k : ‚Ñï) ‚Üí n‚ÇÅ ‚Ñ§+ pos k Ôºù n‚ÇÇ ‚Üí (pr‚ÇÅ (Œ∂ n‚ÇÅ) ‚â§‚Ñ§[1/2] pr‚ÇÅ (Œ∂ n‚ÇÇ)) √ó (pr‚ÇÇ (Œ∂ n‚ÇÇ) ‚â§‚Ñ§[1/2] pr‚ÇÇ (Œ∂ n‚ÇÅ))
is-odcs-c‚ÇÉ-lemma-ns Œ∂ (c‚ÇÅ , c‚ÇÇ , c‚ÇÉ) n‚ÇÅ n‚ÇÇ 0        e = transport (Œª - ‚Üí pr‚ÇÅ (Œ∂ n‚ÇÅ) ‚â§ pr‚ÇÅ (Œ∂ -)) e (‚â§-refl (pr‚ÇÅ (Œ∂ n‚ÇÅ)))
                                                      , transport (Œª - ‚Üí pr‚ÇÇ (Œ∂ -) ‚â§ pr‚ÇÇ (Œ∂ n‚ÇÅ)) e (‚â§-refl (pr‚ÇÇ (Œ∂ n‚ÇÅ)))
is-odcs-c‚ÇÉ-lemma-ns Œ∂ (c‚ÇÅ , c‚ÇÇ , c‚ÇÉ) n‚ÇÅ n‚ÇÇ 1 e = transport (Œª - ‚Üí pr‚ÇÅ (Œ∂ n‚ÇÅ) ‚â§ pr‚ÇÅ (Œ∂ -)) e (pr‚ÇÅ (c‚ÇÉ n‚ÇÅ))
                                               , transport (Œª - ‚Üí pr‚ÇÇ (Œ∂ -) ‚â§ pr‚ÇÇ (Œ∂ n‚ÇÅ)) e (pr‚ÇÇ (c‚ÇÉ n‚ÇÅ)) 
is-odcs-c‚ÇÉ-lemma-ns Œ∂ (c‚ÇÅ , c‚ÇÇ , c‚ÇÉ) n‚ÇÅ n‚ÇÇ (succ (succ k)) e with (is-odcs-c‚ÇÉ-lemma-ns Œ∂ (c‚ÇÅ , c‚ÇÇ , c‚ÇÉ) n‚ÇÅ (pred‚Ñ§ n‚ÇÇ) (succ k) (predsucc‚Ñ§ (succ‚Ñ§ (n‚ÇÅ +pos k)) ‚Åª¬π ‚àô ap pred‚Ñ§ e))
... | (l‚ÇÅ , l‚ÇÇ) = trans' (pr‚ÇÅ (Œ∂ n‚ÇÅ)) (pr‚ÇÅ (Œ∂ (pred‚Ñ§ n‚ÇÇ))) (pr‚ÇÅ (Œ∂ n‚ÇÇ)) l‚ÇÅ (transport (Œª - ‚Üí pr‚ÇÅ (Œ∂ (pred‚Ñ§ n‚ÇÇ)) ‚â§‚Ñ§[1/2] pr‚ÇÅ (Œ∂ -)) (succpred‚Ñ§ n‚ÇÇ) (pr‚ÇÅ (c‚ÇÉ (pred‚Ñ§ n‚ÇÇ))))
                , trans' (pr‚ÇÇ (Œ∂ n‚ÇÇ)) (pr‚ÇÇ (Œ∂ (pred‚Ñ§ n‚ÇÇ))) (pr‚ÇÇ (Œ∂ n‚ÇÅ)) (transport (Œª - ‚Üí pr‚ÇÇ (Œ∂ -) ‚â§‚Ñ§[1/2] pr‚ÇÇ (Œ∂ (pred‚Ñ§ n‚ÇÇ))) (succpred‚Ñ§ n‚ÇÇ) (pr‚ÇÇ (c‚ÇÉ (pred‚Ñ§ n‚ÇÇ)))) l‚ÇÇ

is-odcs-c‚ÇÉ-lemma : (Œ∂ : (‚Ñ§ ‚Üí ‚Ñ§[1/2] √ó ‚Ñ§[1/2])) ‚Üí ((c‚ÇÅ , c‚ÇÇ , c‚ÇÉ) : is-odcs Œ∂)
                 ‚Üí (n‚ÇÅ n‚ÇÇ : ‚Ñ§) ‚Üí n‚ÇÅ ‚â§ n‚ÇÇ ‚Üí (pr‚ÇÅ (Œ∂ n‚ÇÅ) ‚â§‚Ñ§[1/2] pr‚ÇÅ (Œ∂ n‚ÇÇ)) √ó (pr‚ÇÇ (Œ∂ n‚ÇÇ) ‚â§‚Ñ§[1/2] pr‚ÇÇ (Œ∂ n‚ÇÅ))
is-odcs-c‚ÇÉ-lemma Œ∂ c n‚ÇÅ n‚ÇÇ (k , e) = is-odcs-c‚ÇÉ-lemma-ns Œ∂ c n‚ÇÅ n‚ÇÇ k e

postulate
 ‚Ñ§[1/2]-ordering-property : (a b c d : ‚Ñ§[1/2]) ‚Üí (a - b) < (c - d) ‚Üí (a < c) ‚àî (d < b)

-- Lem 1.6
‚¶Ö_‚¶Ü : Œ£ is-odcs ‚Üí ‚Ñù-d
‚¶Ö Œ∂ , (c‚ÇÅ , c‚ÇÇ , c‚ÇÉ) ‚¶Ü
 = (L , R)
 , inhabited-l , inhabited-r
 , rounded-l   , rounded-r
 , is-disjoint , is-located
 where
  L R : ùìü ‚Ñ§[1/2]
  L p = (‚àÉ n Íûâ ‚Ñ§ , (p <‚Ñ§[1/2] pr‚ÇÅ (Œ∂ n))) , ‚àÉ-is-prop
  R q = (‚àÉ n Íûâ ‚Ñ§ , (pr‚ÇÇ (Œ∂ n) <‚Ñ§[1/2] q)) , ‚àÉ-is-prop
  inhabited-l : inhabited-left L
  inhabited-l = ‚à£ (pr‚ÇÅ (Œ∂ (pos 0)) - 1‚Ñ§[1/2])
              , ‚à£ pos 0 , ‚Ñ§[1/2]<-neg (pr‚ÇÅ (Œ∂ (pos 0))) 1‚Ñ§[1/2] 0<1‚Ñ§[1/2] ‚à£ ‚à£
  inhabited-r : inhabited-right R
  inhabited-r = ‚à£ (pr‚ÇÇ (Œ∂ (pos 0)) + 1‚Ñ§[1/2])
             , ‚à£ pos 0  , ‚Ñ§[1/2]<-+ (pr‚ÇÇ (Œ∂ (pos 0))) 1‚Ñ§[1/2] 0<1‚Ñ§[1/2] ‚à£ ‚à£
  rounded-l : rounded-left L
  rounded-l p = ltr , rtl
   where
    ltr : ‚àÉ n Íûâ ‚Ñ§ , (p <‚Ñ§[1/2] pr‚ÇÅ (Œ∂ n)) ‚Üí ‚àÉ p' Íûâ ‚Ñ§[1/2] , p < p' √ó (‚àÉ n' Íûâ ‚Ñ§ , (p' <‚Ñ§[1/2] pr‚ÇÅ (Œ∂ n')))
    ltr = ‚à•‚à•-functor I
     where
      I : Œ£ n Íûâ ‚Ñ§ , (p <‚Ñ§[1/2] pr‚ÇÅ (Œ∂ n)) ‚Üí Œ£ p' Íûâ ‚Ñ§[1/2] , p < p' √ó (‚àÉ n' Íûâ ‚Ñ§ , (p' <‚Ñ§[1/2] pr‚ÇÅ (Œ∂ n')))
      I (n , p<Œ∂n) = let (p' , p<p' , p'<Œ∂n) = dense p (pr‚ÇÅ (Œ∂ n)) p<Œ∂n
                     in p' , (p<p' , ‚à£ n , p'<Œ∂n ‚à£)
    rtl : ‚àÉ p' Íûâ ‚Ñ§[1/2] , p < p' √ó (‚àÉ n Íûâ ‚Ñ§ , (p' <‚Ñ§[1/2] pr‚ÇÅ (Œ∂ n)))
        ‚Üí ‚àÉ n Íûâ ‚Ñ§ , (p <‚Ñ§[1/2] pr‚ÇÅ (Œ∂ n))
    rtl = ‚à•‚à•-rec ‚àÉ-is-prop I
     where
      I : Œ£ p' Íûâ ‚Ñ§[1/2] , p < p' √ó (‚àÉ n Íûâ ‚Ñ§ , (p' <‚Ñ§[1/2] pr‚ÇÅ (Œ∂ n)))
        ‚Üí ‚àÉ n Íûâ ‚Ñ§ , (p <‚Ñ§[1/2] pr‚ÇÅ (Œ∂ n))
      I (p' , p<p' , te) = ‚à•‚à•-functor II te
       where
        II : Œ£ n Íûâ ‚Ñ§ , (p' <‚Ñ§[1/2] pr‚ÇÅ (Œ∂ n)) ‚Üí Œ£ n Íûâ ‚Ñ§ , (p <‚Ñ§[1/2] pr‚ÇÅ (Œ∂ n))
        II (n  , p'<Œ∂n) = n , (trans p p' (pr‚ÇÅ (Œ∂ n)) p<p' p'<Œ∂n)
      
  rounded-r : rounded-right R
  rounded-r q = ltr , rtl
   where
    ltr : ‚àÉ n Íûâ ‚Ñ§ , pr‚ÇÇ (Œ∂ n) < q ‚Üí ‚àÉ q' Íûâ ‚Ñ§[1/2] , q' < q √ó q' ‚àà R
    ltr = ‚à•‚à•-functor I
     where
      I : Œ£ n Íûâ ‚Ñ§ , pr‚ÇÇ (Œ∂ n) < q ‚Üí Œ£ q' Íûâ ‚Ñ§[1/2] , q' < q √ó q' ‚àà R
      I (n , Œ∂n<q) = let (q' , Œ∂n<q' , q'<q) = dense (pr‚ÇÇ (Œ∂ n)) q Œ∂n<q
                     in q' , (q'<q , ‚à£ n , Œ∂n<q' ‚à£)
    rtl : ‚àÉ q' Íûâ ‚Ñ§[1/2] , q' < q √ó (R q' holds) ‚Üí R q holds
    rtl = ‚à•‚à•-rec ‚àÉ-is-prop I
     where
      I : Œ£ q' Íûâ ‚Ñ§[1/2] , q' < q √ó (R q' holds) ‚Üí R q holds
      I (q' , q'<q , te) = ‚à•‚à•-functor II te
       where
        II : Œ£ n Íûâ ‚Ñ§ , (pr‚ÇÇ (Œ∂ n) < q') ‚Üí Œ£ n Íûâ ‚Ñ§ , (pr‚ÇÇ (Œ∂ n) <‚Ñ§[1/2] q)
        II (n , Œ∂<q') = n , (trans (pr‚ÇÇ (Œ∂ n)) q' q Œ∂<q' q'<q)
  
  is-disjoint : disjoint L R
  is-disjoint p q (tp<x , tx<q) = ‚à•‚à•-rec (<‚Ñ§[1/2]-is-prop p q) I (binary-choice tp<x tx<q)
   where
    I : (Œ£ n Íûâ ‚Ñ§ , (p <‚Ñ§[1/2] pr‚ÇÅ (Œ∂ n))) √ó (Œ£ n' Íûâ ‚Ñ§ , (pr‚ÇÇ (Œ∂ n') <‚Ñ§[1/2] q))
      ‚Üí p <‚Ñ§[1/2] q
    I ((n , p<l) , (n' , r<q)) with ‚Ñ§-dichotomous n n'
    ... | inl n‚â§n' = let p<l' = ‚Ñ§[1/2]<-‚â§ p (pr‚ÇÅ (Œ∂ n)) (pr‚ÇÅ (Œ∂ n')) p<l (pr‚ÇÅ (is-odcs-c‚ÇÉ-lemma Œ∂ (c‚ÇÅ , c‚ÇÇ , c‚ÇÉ) n n' n‚â§n'))
                         l<q' = ‚Ñ§[1/2]‚â§-< (pr‚ÇÅ (Œ∂ n')) (pr‚ÇÇ (Œ∂ n')) q (c‚ÇÅ n') r<q
                     in trans p (pr‚ÇÅ (Œ∂ n')) q p<l' l<q'
    ... | inr n'‚â§n = let p<r' = ‚Ñ§[1/2]<-‚â§ p (pr‚ÇÅ (Œ∂ n)) (pr‚ÇÇ (Œ∂ n)) p<l (c‚ÇÅ n)
                         r<q' = ‚Ñ§[1/2]‚â§-< (pr‚ÇÇ (Œ∂ n)) (pr‚ÇÇ (Œ∂ n')) q (pr‚ÇÇ (is-odcs-c‚ÇÉ-lemma Œ∂ (c‚ÇÅ , c‚ÇÇ , c‚ÇÉ) n' n n'‚â§n)) r<q
                     in trans p (pr‚ÇÇ (Œ∂ n)) q p<r' r<q'
 
  is-located : located L R
  is-located p q p<q = I (c‚ÇÇ (1/2 * (q - p)))
   where
    0<Œµ : 0‚Ñ§[1/2] < (1/2 * (q - p))
    0<Œµ = <-pos-mult' 1/2 (q - p) 0<1/2‚Ñ§[1/2] (diff-positive p q p<q)
    I : (Œ£ n Íûâ ‚Ñ§ , ((pr‚ÇÇ (Œ∂ n) - pr‚ÇÅ (Œ∂ n)) ‚â§‚Ñ§[1/2] (1/2 * (q - p)))) ‚Üí (L p holds) ‚à® (R q holds)
    I (n , l‚ÇÅ) = II (‚Ñ§[1/2]-ordering-property (pr‚ÇÇ (Œ∂ n)) (pr‚ÇÅ (Œ∂ n)) q p l‚ÇÇ)
     where
      l‚ÇÇ :(pr‚ÇÇ (Œ∂ n) - pr‚ÇÅ (Œ∂ n)) < (q - p)
      l‚ÇÇ = ‚Ñ§[1/2]‚â§-< (pr‚ÇÇ (Œ∂ n) - pr‚ÇÅ (Œ∂ n)) (1/2 * (q - p)) (q - p) l‚ÇÅ (‚Ñ§[1/2]-1/2-< (q - p) (diff-positive p q p<q))
      II : pr‚ÇÇ (Œ∂ n) < q ‚àî p < pr‚ÇÅ (Œ∂ n) ‚Üí (L p holds) ‚à® (R q holds)
      II (inl Œ∂<q) = ‚à£ inr ‚à£ n , Œ∂<q ‚à£ ‚à£
      II (inr p<Œ∂) = ‚à£ inl ‚à£ n , p<Œ∂ ‚à£ ‚à£

-- Def 1.7
Œ∑ Œ∑‚Å∫¬≤ : ‚Ñ§ √ó ‚Ñ§ ‚Üí ‚Ñ§[1/2]
Œ∑   = normalise
Œ∑‚Å∫¬≤ (k , p) = normalise (k +pos 2 , p)

-- Def 1.8
Œ∑[_] : ‚Ñ§ √ó ‚Ñ§ ‚Üí ‚Ñ§[1/2] √ó ‚Ñ§[1/2]
Œ∑[ (k , p) ] = Œ∑ (k , p) , Œ∑‚Å∫¬≤ (k , p)

-- Lem 1.9
||_|| : (‚Ñ§ ‚Üí ‚Ñ§ √ó ‚Ñ§) ‚Üí (‚Ñ§ ‚Üí ùîª √ó ùîª)
|| Œæ || = Œ∑[_] ‚àò Œæ

is-gbr : (‚Ñ§ ‚Üí ‚Ñ§ √ó ‚Ñ§) ‚Üí ùì§‚ÇÄ  Ãá
is-gbr Œæ = ((œµ : ùîª) ‚Üí Œ£ n Íûâ ‚Ñ§ , (normalise ((pos 1) , (pred‚Ñ§ (pr‚ÇÇ (Œæ n)))) ‚â§ œµ))
         √ó ((n : ‚Ñ§) ‚Üí (Œ∑ (Œæ n) ‚â§ Œ∑ (Œæ (succ‚Ñ§ n))) √ó (Œ∑‚Å∫¬≤ (Œæ (succ‚Ñ§ n)) ‚â§ Œ∑‚Å∫¬≤ (Œæ n)))

ùîæ-gives-odcs : (Œæ : ‚Ñ§ ‚Üí ‚Ñ§ √ó ‚Ñ§) ‚Üí is-gbr Œæ ‚Üí is-odcs || Œæ ||
ùîæ-gives-odcs Œæ (Œæc‚ÇÅ , Œæc‚ÇÇ) = c‚ÇÅ , c‚ÇÇ , Œæc‚ÇÇ
 where
  c‚ÇÅ : (n : ‚Ñ§) ‚Üí pr‚ÇÅ (|| Œæ || n) ‚â§‚Ñ§[1/2] pr‚ÇÇ (|| Œæ || n)
  c‚ÇÅ n = <-is-‚â§‚Ñ§[1/2] (pr‚ÇÅ (|| Œæ || n)) (pr‚ÇÇ (|| Œæ || n)) (normalise-< (Œæ n))
  c‚ÇÇ : (œµ : ùîª) ‚Üí Œ£ n Íûâ ‚Ñ§ , (pr‚ÇÇ (|| Œæ || n) - pr‚ÇÅ (|| Œæ || n)) ‚â§‚Ñ§[1/2] œµ
  c‚ÇÇ Œµ with Œæc‚ÇÅ Œµ 
  ... | (n , l) = n , (transport (_‚â§ Œµ) (normalise-equality (Œæ n)) l)

-- Lem 1.10
<_> : ùïã ‚Üí (‚Ñ§ ‚Üí ‚Ñ§ √ó ‚Ñ§)
< œá , b > n = œá n , n

<>-is-gbr-lemma‚ÇÅ : ((œá , b) : ùïã) ‚Üí (n : ‚Ñ§) ‚Üí normalise (œá n , n) ‚â§ normalise (œá (succ‚Ñ§ n) , (succ‚Ñ§ n))
<>-is-gbr-lemma‚ÇÅ = {!easy !}

<>-is-gbr-lemma‚ÇÇ : ((œá , b) : ùïã) ‚Üí (n : ‚Ñ§) ‚Üí normalise (succ‚Ñ§ (succ‚Ñ§ (œá (succ‚Ñ§ n))) , (succ‚Ñ§ n)) ‚â§ normalise (succ‚Ñ§ (succ‚Ñ§ (œá n)) , n)
<>-is-gbr-lemma‚ÇÇ = {!easy!}

normalise-Œµ : ((œá , b) : ùïã) ‚Üí (Œµ : ‚Ñ§[1/2]) ‚Üí Œ£ n Íûâ ‚Ñ§ , (normalise (pos 1 , pred‚Ñ§ (pr‚ÇÇ (< œá , b > n))) ‚â§ Œµ)
normalise-Œµ = {!should be easy!}

<>-is-gbr : (œá : ùïã) ‚Üí is-gbr < œá >
<>-is-gbr œá = normalise-Œµ œá , (Œª n ‚Üí <>-is-gbr-lemma‚ÇÅ œá n
                                   , <>-is-gbr-lemma‚ÇÇ œá n)
  
<>-gives-odcs : (œá : ùïã) ‚Üí is-odcs || < œá > ||
<>-gives-odcs œá = ùîæ-gives-odcs < œá > (<>-is-gbr œá)

open import Todd.BelowAndAbove fe hiding (downLeft ; downMid ; downRight ; upLeft ; upRight ; _below_ ; _above_ ; Vec)

postulate
 normalise-succ : (z n : ‚Ñ§) ‚Üí normalise (z , n) ‚â§ normalise (z ‚Ñ§+ z , succ‚Ñ§ n)

<>-is-odcs : (œá : ùïã) ‚Üí is-odcs || < œá > ||
<>-is-odcs (œá , b) = <>-gives-odcs (œá , b)

-- Def 1.11
‚ü¶_‚üß' : ùïã ‚Üí ‚Ñù-d
‚ü¶ œá ‚üß' = ‚¶Ö _ , <>-gives-odcs œá ‚¶Ü

-- FUNCTIONS


-- JOINING

-- Def 1.14

J' : ùîª √ó ùîª ‚Üí ‚Ñ§ √ó ‚Ñ§ √ó ‚Ñ§
J' (((a , p‚ÇÅ) , _) , ((b , p‚ÇÇ) , _)) = rec a downLeft  (abs (max‚Ñ§ (pos p‚ÇÅ) (pos p‚ÇÇ) ‚Ñ§- pos p‚ÇÅ))
                                     , rec b downRight (abs (max‚Ñ§ (pos p‚ÇÅ) (pos p‚ÇÇ) ‚Ñ§- pos p‚ÇÇ))
                                     , max‚Ñ§ (pos p‚ÇÅ) (pos p‚ÇÇ)

-- Def 1.15

_/2 : ‚Ñï ‚Üí ‚Ñï
zero /2 = 0
succ zero /2 = 0
succ (succ x) /2 = succ (x /2)

{-# TERMINATING #-}
upValue : ‚Ñï ‚Üí ‚Ñï -- roughly clog2(x+1) (0 1 2 4 8 16)
upValue 0 = 0
upValue (succ n) = succ (upValue (succ n /2))

-- need proofs that upValue provides correct covering

join : (‚Ñ§ ‚Üí ùîª √ó ùîª) ‚Üí (‚Ñ§ ‚Üí ‚Ñ§ √ó ‚Ñ§)
join Œ∂ n = rec a upRight m , p ‚Ñ§- pos m
 where
   abp = J' (Œ∂ n)
   a =  pr‚ÇÅ        abp
   b = (pr‚ÇÅ ‚àò pr‚ÇÇ) abp
   p = (pr‚ÇÇ ‚àò pr‚ÇÇ) abp
   m = upValue (abs (b ‚Ñ§- a))

-- Lem 1.16

join-is-gbr : (Œ∂ : ‚Ñ§ ‚Üí ùîª √ó ùîª) ‚Üí is-gbr (join Œ∂)
join-is-gbr Œ∂ = {!!}

join-is-odcs : (Œ∂ : ‚Ñ§ ‚Üí ùîª √ó ùîª) ‚Üí is-odcs || join Œ∂ ||
join-is-odcs Œ∂ = ùîæ-gives-odcs (join Œ∂) (join-is-gbr Œ∂)

-- Lem 1.17

_‚â°_ = _Ôºù_

join-same-real : ((Œ∂ , i) : Œ£ is-odcs) ‚Üí (io : is-odcs || join Œ∂ ||) ‚Üí ‚¶Ö Œ∂ , i ‚¶Ü ‚â° ‚¶Ö || join Œ∂ || , io ‚¶Ü
join-same-real = {!!}

-- PRE-NORMALISING

-- Def 1.18

Œ∫-prenorm : (Œ∫ : ‚Ñ§ ‚Üí ‚Ñ§) ‚Üí ùì§‚ÇÄ Ãá
Œ∫-prenorm Œ∫ = ((n : ‚Ñ§) ‚Üí Œ∫ n ‚â§ Œ∫ (succ‚Ñ§ n))
            √ó ((n : ‚Ñ§) ‚Üí n ‚â§ Œ∫ n)

is-prenormalised : (‚Ñ§ ‚Üí ‚Ñ§ √ó ‚Ñ§) ‚Üí ùì§‚ÇÄ Ãá
is-prenormalised Œ∂ = (n : ‚Ñ§) ‚Üí pr‚ÇÇ (Œ∂ n) ‚â• n

-- Def 1.19

prenorm-for_ : (‚Ñ§ ‚Üí ‚Ñ§ √ó ‚Ñ§) ‚Üí ùì§‚ÇÄ Ãá
prenorm-for œá = Œ£ Œ∫ Íûâ (‚Ñ§ ‚Üí ‚Ñ§) , (is-prenormalised (œá ‚àò Œ∫))
                              √ó ((n : ‚Ñ§) ‚Üí Œ∫ n ‚â§ Œ∫ (succ‚Ñ§ n))
                              √ó ((n : ‚Ñ§) ‚Üí n ‚â§ Œ∫ n)

-- Lem 1.20

prenorm : (œá : ‚Ñ§ ‚Üí ‚Ñ§ √ó ‚Ñ§) ‚Üí prenorm-for œá ‚Üí (‚Ñ§ ‚Üí ‚Ñ§ √ó ‚Ñ§)
prenorm œá (Œ∫ , i) = œá ‚àò Œ∫

prenorm-is-prenormalised : (œá : ‚Ñ§ ‚Üí ‚Ñ§ √ó ‚Ñ§) ‚Üí (Œ∫ : prenorm-for œá)
                         ‚Üí is-prenormalised (prenorm œá Œ∫)
prenorm-is-prenormalised œá (Œ∫ , Œ∫f , Œ∫s) = Œ∫f

normalise-‚â§-lemma : ((x , a) (y , b) : ‚Ñ§ √ó ‚Ñ§)
                  ‚Üí x ‚Ñ§* b ‚â§ y ‚Ñ§* a
                  ‚Üí normalise (x , a) ‚â§ normalise (y , b)
normalise-‚â§-lemma = {!easy (but long proof)!}

prenorm-is-gbr-lemma : (a b : ‚Ñ§) ‚Üí a ‚â§ b ‚Üí normalise (pos 1 , b) ‚â§ normalise (pos 1 , a)
prenorm-is-gbr-lemma a b l =
 normalise-‚â§-lemma (pos 1 , b) (pos 1 , a)
  (transport‚ÇÇ _‚â§_ (‚Ñ§-mult-left-id a ‚Åª¬π) (‚Ñ§-mult-left-id b ‚Åª¬π) l)

prenorm-is-gbr : (œá : ‚Ñ§ ‚Üí ‚Ñ§ √ó ‚Ñ§)
               ‚Üí (Œ∫ : prenorm-for œá)
               ‚Üí is-gbr œá
               ‚Üí is-gbr (prenorm œá Œ∫)
prenorm-is-gbr œá (Œ∫ , Œ∫f , Œ∫s , Œ∫‚â§) (c‚ÇÅ , c‚ÇÇ) = c‚ÇÅ' , c‚ÇÇ'
 where
  c‚ÇÅ' : (Œµ : ‚Ñ§[1/2]) ‚Üí Œ£ n Íûâ ‚Ñ§ , normalise (pos 1 , pred‚Ñ§ (pr‚ÇÇ (œá (Œ∫ n)))) ‚â§ Œµ
  c‚ÇÅ' Œµ = I (c‚ÇÅ Œµ)
   where
    I : (Œ£ n  Íûâ ‚Ñ§ , normalise (pos 1 , pred‚Ñ§ (pr‚ÇÇ (œá n)))      ‚â§ Œµ)
       ‚Üí Œ£ n' Íûâ ‚Ñ§ , normalise (pos 1 , pred‚Ñ§ (pr‚ÇÇ (œá (Œ∫ n')))) ‚â§ Œµ
    I (n , l') = n , trans' (normalise (pos 1 , pred‚Ñ§ (pr‚ÇÇ (œá (Œ∫ n))))) (normalise (pos 1 , pred‚Ñ§ (pr‚ÇÇ (œá n)))) Œµ l‚ÇÇ l'
     where
      i : n ‚â§ Œ∫ n
      i = Œ∫‚â§ n
      ii : (n‚ÇÅ n‚ÇÇ : ‚Ñ§) ‚Üí n‚ÇÅ ‚â§ n‚ÇÇ ‚Üí normalise (œá n‚ÇÅ) ‚â§ normalise (œá n‚ÇÇ) 
      ii n‚ÇÅ n‚ÇÇ l = {!induction using c‚ÇÇ!}
      iii : normalise (œá n) ‚â§ normalise (œá (Œ∫ n))
      iii = ii n (Œ∫ n) i
      iv : {!!}
      iv = {!!}

      
      {-
      i : (n‚ÇÅ n‚ÇÇ : ‚Ñ§) ‚Üí n‚ÇÅ ‚â§ n‚ÇÇ ‚Üí pr‚ÇÇ (œá n‚ÇÅ) ‚â§ pr‚ÇÇ (œá n‚ÇÇ) 
      i n‚ÇÅ n‚ÇÇ n‚ÇÅ‚â§n‚ÇÇ = {!!}
      
      œán‚â§œáŒ∫n : pr‚ÇÇ (œá n) ‚â§ pr‚ÇÇ (œá (Œ∫ n))
      œán‚â§œáŒ∫n = i n (Œ∫ n) (Œ∫‚â§ n)
      -}
      l‚ÇÇ : normalise (pos 1 , pred‚Ñ§ (pr‚ÇÇ (œá (Œ∫ n)))) ‚â§‚Ñ§[1/2] normalise (pos 1 , pred‚Ñ§ (pr‚ÇÇ (œá n)))
      l‚ÇÇ = {!!} -- prenorm-is-gbr-lemma (pred‚Ñ§ (pr‚ÇÇ (œá n))) (pred‚Ñ§ (pr‚ÇÇ (œá (Œ∫ n))))
                -- (‚â§-pred‚Ñ§' (pr‚ÇÇ (œá n)) (pr‚ÇÇ (œá (Œ∫ n))) œán‚â§œáŒ∫n)

  c‚ÇÇ' : (n : ‚Ñ§)
      ‚Üí (normalise (prenorm œá (Œ∫ , Œ∫f , Œ∫s , Œ∫‚â§) n) ‚â§ normalise (prenorm œá (Œ∫ , Œ∫f , Œ∫s , Œ∫‚â§) (succ‚Ñ§ n)))
      √ó (Œ∑‚Å∫¬≤ (prenorm œá (Œ∫ , Œ∫f , Œ∫s , Œ∫‚â§) (succ‚Ñ§ n))) ‚â§ (Œ∑‚Å∫¬≤ (prenorm œá (Œ∫ , Œ∫f , Œ∫s , Œ∫‚â§) n))
  c‚ÇÇ' n = I , II
   where
    induct‚ÇÅ : (n‚ÇÅ n‚ÇÇ : ‚Ñ§) ‚Üí n‚ÇÅ ‚â§ n‚ÇÇ ‚Üí normalise (œá n‚ÇÅ) ‚â§ normalise (œá n‚ÇÇ)
    induct‚ÇÅ n‚ÇÅ n‚ÇÇ n‚ÇÅ‚â§n‚ÇÇ = {!--easy induction!}

    induct‚ÇÇ : (n‚ÇÅ n‚ÇÇ : ‚Ñ§) ‚Üí n‚ÇÅ ‚â§ n‚ÇÇ ‚Üí Œ∑‚Å∫¬≤ (œá n‚ÇÇ) ‚â§ Œ∑‚Å∫¬≤ (œá n‚ÇÅ)
    induct‚ÇÇ n‚ÇÅ n‚ÇÇ n‚ÇÅ‚â§n‚ÇÇ = {!easy induction!}
    
    I : normalise (œá (Œ∫ n)) ‚â§ normalise (œá (Œ∫ (succ‚Ñ§ n)))
    I = induct‚ÇÅ (Œ∫ n) (Œ∫ (succ‚Ñ§ n)) (Œ∫s n)

    II : Œ∑‚Å∫¬≤ (œá (Œ∫ (succ‚Ñ§ n))) ‚â§ Œ∑‚Å∫¬≤ (œá (Œ∫ n))
    II = induct‚ÇÇ (Œ∫ n) (Œ∫ (succ‚Ñ§ n)) (Œ∫s n)
  
prenorm-is-odcs : (œá : ‚Ñ§ ‚Üí ‚Ñ§ √ó ‚Ñ§)
                ‚Üí (Œ∫ : prenorm-for œá)
                ‚Üí is-gbr œá
                ‚Üí is-odcs || prenorm œá Œ∫ ||
prenorm-is-odcs œá Œ∫ igbr = ùîæ-gives-odcs (prenorm œá Œ∫) (prenorm-is-gbr œá Œ∫ igbr)

prenorm-same-real : (œá : ‚Ñ§ ‚Üí ‚Ñ§ √ó ‚Ñ§)
                  ‚Üí (i : is-odcs || œá ||)
                  ‚Üí (Œ∫ : prenorm-for œá)
                  ‚Üí (io : is-odcs || prenorm œá Œ∫ ||)
                  ‚Üí ‚¶Ö || œá || , i ‚¶Ü ‚â° ‚¶Ö || prenorm œá Œ∫ || , io ‚¶Ü
prenorm-same-real œá i (Œ∫ , Œ∫ps) io = ‚Ñù-d-equality-from-left-cut ltr rtl
 where
  ltr : lower-cut-of ‚¶Ö || œá || , i ‚¶Ü ‚äÜ lower-cut-of ‚¶Ö || prenorm œá (Œ∫ , Œ∫ps) || , io ‚¶Ü
  ltr p = ‚à•‚à•-functor I
   where
    I : Œ£ n Íûâ ‚Ñ§ , (p <‚Ñ§[1/2] Œ∑ (œá n))
      ‚Üí Œ£ n Íûâ ‚Ñ§ , (p <‚Ñ§[1/2] Œ∑ (œá (Œ∫ n)))
    I (n , p<Œæn) = n , {!!}
  rtl : lower-cut-of ‚¶Ö || prenorm œá (Œ∫ , Œ∫ps) || , io ‚¶Ü ‚äÜ lower-cut-of ‚¶Ö || œá || , i ‚¶Ü
  rtl p = ‚à•‚à•-functor I
   where
    I : Œ£ n Íûâ ‚Ñ§ , (p <‚Ñ§[1/2] Œ∑ (œá (Œ∫ n)))
      ‚Üí Œ£ n Íûâ ‚Ñ§ , (p <‚Ñ§[1/2] Œ∑ (œá n))
    I (n , p<œáŒ∫n) = {!!}

-- Lem 1.21

is-normalised : (‚Ñ§ ‚Üí ‚Ñ§ √ó ‚Ñ§) ‚Üí ùì§‚ÇÄ Ãá
is-normalised Œ∂ = (n : ‚Ñ§) ‚Üí pr‚ÇÇ (Œ∂ n) ‚â° n

-- Lem 1.23

norm : (œá : ‚Ñ§ ‚Üí ‚Ñ§ √ó ‚Ñ§) ‚Üí is-prenormalised œá ‚Üí (‚Ñ§ ‚Üí ‚Ñ§ √ó ‚Ñ§)
norm œá ipœá n = rec (pr‚ÇÅ (œá n)) upRight (abs (n ‚Ñ§- pr‚ÇÇ (œá n))) , n

norm-is-normalised : (œá : ‚Ñ§ ‚Üí ‚Ñ§ √ó ‚Ñ§) ‚Üí (ipœá : is-prenormalised œá) ‚Üí is-normalised (norm œá ipœá)
norm-is-normalised œá ipœá n = refl

normalised-are-prenormalised : (œá : ‚Ñ§ ‚Üí ‚Ñ§ √ó ‚Ñ§) ‚Üí is-normalised œá ‚Üí is-prenormalised œá
normalised-are-prenormalised œá i n = 0 , (i n ‚Åª¬π)

norm-is-prenormalised : (œá : ‚Ñ§ ‚Üí ‚Ñ§ √ó ‚Ñ§)
                      ‚Üí (ip : is-prenormalised œá)
                      ‚Üí is-prenormalised (norm œá ip) 
norm-is-prenormalised œá ip = normalised-are-prenormalised (norm œá ip) (norm-is-normalised œá ip)

-- (œá : Z ‚Üí Z x Z) ‚Üí (ipx : is-prenormalised œá) ‚Üí ((Œ∫ , _) : prenorm-for œá) ‚Üí Œ∫ ‚àº id
-- (œá : Z ‚Üí Z x Z) ‚Üí (ipx : is-prenormalised œá) ‚Üí prenorm-for œá (i.e. id)
-- (œá : Z ‚Üí Z x Z) ‚Üí (ipx : is-prenormalised œá) ‚Üí (Œ∫ : prenorm-for œá) ‚Üí prenorm œá Œ∫ ‚àº œá

norm-is-gbr : (œá : ‚Ñ§ ‚Üí ‚Ñ§ √ó ‚Ñ§)
            ‚Üí is-gbr œá
            ‚Üí (ipœá : is-prenormalised œá)
            ‚Üí is-gbr (norm œá ipœá)
norm-is-gbr œá igbrœá ipœá = {!!}

norm-is-odcs : (œá : ‚Ñ§ ‚Üí ‚Ñ§ √ó ‚Ñ§)
             ‚Üí is-gbr œá 
             ‚Üí (ipœá : is-prenormalised œá)
             ‚Üí is-odcs || norm œá ipœá ||
norm-is-odcs œá gbrœá ip = prenorm-is-odcs (norm œá ip) Œ∫' (prenorm-is-gbr (norm œá ip) Œ∫' (norm-is-gbr œá gbrœá ip))
 where
  Œ∫' : prenorm-for norm œá ip
  Œ∫' = id , (norm-is-prenormalised œá ip) , (Œª n ‚Üí 1 , refl) , (Œª n ‚Üí 0 , refl)
                   

norm-same-real : (œá : ‚Ñ§ ‚Üí ‚Ñ§ √ó ‚Ñ§)
               ‚Üí (i : is-odcs || œá ||)
               ‚Üí (ip : is-prenormalised œá)
               ‚Üí (io : is-odcs || norm œá ip ||)
               ‚Üí ‚¶Ö || œá || , i ‚¶Ü ‚â° ‚¶Ö || norm œá ip || , io ‚¶Ü
norm-same-real œá i ip io = {!!}

-- Def 1.24

toTB : Œ£ is-normalised ‚Üí ùïã
toTB (œá , œáin) = (Œª n ‚Üí pr‚ÇÅ (œá n)) , {!!}

toTB-same-real : ((œá , œáin) : Œ£ is-normalised)
               ‚Üí (i : is-odcs || œá ||)
               ‚Üí ‚ü¶ toTB (œá , œáin) ‚üß' ‚â° ‚¶Ö || œá || , i ‚¶Ü
toTB-same-real = {!!}

```

To be re-organised and commented.

```agda

open import Todd.BuildingBlocks pt fe pe sq

record Approximations : ùì§ Ãá where
 field
  n : ‚Ñï
  C : Collection n
 open Collection C

-- Lem 1.12

 F' : Vec (Œ£ is-odcs) n ‚Üí ‚Ñ§ ‚Üí ‚Ñ§[1/2] √ó ‚Ñ§[1/2]
 F' Œ∂s n = (L (vec-map (Œª (Œ∂ , odcs) ‚Üí Œ∂ n) Œ∂s))
         , (R (vec-map (Œª (Œ∂ , odcs) ‚Üí Œ∂ n) Œ∂s))

 F'-is-odcs : (Œ∂s : Vec (Œ£ is-odcs) n) ‚Üí is-odcs (F' Œ∂s)
 F'-is-odcs Œ∂s = I , {!!} , {!!}
  where
   I : (n : ‚Ñ§) ‚Üí pr‚ÇÅ (F' Œ∂s n) ‚â§‚Ñ§[1/2] pr‚ÇÇ (F' Œ∂s n)
   I n = Condition-4 (vec-map (Œª (Œ∂ , odcs) ‚Üí Œ∂ n) Œ∂s)
                     (vec-map (Œª (Œ∂ , odcs) ‚Üí Œ∂ n) Œ∂s)
 
-- Thm 1.13

 F'-same-real : (Œ∂s : Vec (Œ£ is-odcs) n)
              ‚Üí (i : is-odcs (F' Œ∂s))
              ‚Üí F (vec-map ‚¶Ö_‚¶Ü Œ∂s) ‚â° ‚¶Ö F' Œ∂s , i ‚¶Ü
 F'-same-real Œ∂s i = {!!}

-- Def 1.25

 vŒ∂s : (xs : Vec ùïã n) ‚Üí Vec (Œ£ is-odcs) n
 vŒ∂s xs = vec-map (Œª t ‚Üí || < t > || , (<>-is-odcs t)) xs

 vF' : (xs : Vec ùïã n) ‚Üí ‚Ñ§ ‚Üí ‚Ñ§[1/2] √ó ‚Ñ§[1/2]
 vF' = F' ‚àò vŒ∂s

 vJF' : (xs : Vec ùïã n) ‚Üí ‚Ñ§ ‚Üí ‚Ñ§ √ó ‚Ñ§
 vJF' = join ‚àò vF'

 vPJF' : (xs : Vec ùïã n)
       ‚Üí prenorm-for vJF' xs
       ‚Üí ‚Ñ§ ‚Üí ‚Ñ§ √ó ‚Ñ§
 vPJF' xs p = prenorm (vJF' xs) p

 vNPJF' : (xs : Vec ùïã n)
        ‚Üí (p : prenorm-for vJF' xs)
        ‚Üí is-prenormalised (vPJF' xs p)
        ‚Üí ‚Ñ§ ‚Üí ‚Ñ§ √ó ‚Ñ§
 vNPJF' xs p ip = norm (vPJF' xs p) ip

 F* : (xs : Vec ùïã n)
    ‚Üí (pf : prenorm-for vJF' xs)
    ‚Üí (ip : is-prenormalised (vPJF' xs pf))
    ‚Üí (isn : is-normalised (vNPJF' xs pf ip))
    ‚Üí ùïã
 F* xs xsp ip isn = toTB (vNPJF' xs xsp ip , isn)

 F-same-real : (œás : Vec ùïã n)
             ‚Üí (pf : prenorm-for vJF' œás)
             ‚Üí (ip : is-prenormalised (vPJF' œás pf))
             ‚Üí (isn : is-normalised (vNPJF' œás pf ip))
             ‚Üí ‚ü¶ F* œás pf ip isn ‚üß' ‚â° F (vec-map ‚¶Ö_‚¶Ü (vŒ∂s œás))
 F-same-real œás pf ip isn = ‚ü¶ F* œás pf ip isn ‚üß'                   Ôºù‚ü® toTB-same-real (vNPJF' œás pf ip , isn) jNPF'odcs      ‚ü©
                            ‚¶Ö || vNPJF' œás pf ip || , jNPF'odcs ‚¶Ü  Ôºù‚ü® norm-same-real (vPJF' œás pf) jPF'odcs ip jNPF'odcs ‚Åª¬π ‚ü©
                            ‚¶Ö || vPJF' œás pf ||     , jPF'odcs  ‚¶Ü  Ôºù‚ü® prenorm-same-real (vJF' œás) jF'odcs pf jPF'odcs ‚Åª¬π    ‚ü©
                            ‚¶Ö || vJF' œás ||         , jF'odcs   ‚¶Ü  Ôºù‚ü® join-same-real (vF' œás , F'odcs) jF'odcs ‚Åª¬π           ‚ü©                            
                            ‚¶Ö vF' œás                , F'odcs    ‚¶Ü  Ôºù‚ü® F'-same-real (vŒ∂s œás) F'odcs ‚Åª¬π                       ‚ü©
                            F (vec-map ‚¶Ö_‚¶Ü (vŒ∂s œás))               ‚àé
  where
   jNPF'odcs : is-odcs || norm (vPJF' œás pf) ip ||
   jNPF'odcs = norm-is-odcs (vPJF' œás pf) (prenorm-is-gbr (vJF' œás) pf (join-is-gbr (vF' œás))) ip
   jPF'odcs : is-odcs || prenorm (vJF' œás) pf ||
   jPF'odcs = prenorm-is-odcs (vJF' œás) pf (join-is-gbr (vF' œás))
   jF'odcs : is-odcs || join (F' (vŒ∂s œás)) ||
   jF'odcs = join-is-odcs (vF' œás)
   F'odcs : is-odcs (F' (vŒ∂s œás))
   F'odcs = F'-is-odcs (vŒ∂s œás)
   
```

